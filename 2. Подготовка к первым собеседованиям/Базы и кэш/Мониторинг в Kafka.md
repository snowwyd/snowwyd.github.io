---
layout: default
title: Мониторинг и troubleshooting
permalink: /interview-prep/databases-cache/kafka/monitoring/
---

# Цель
---
Production система Kafka должна быть отмонитирована. Без мониторинга вы не будете знать когда что-то сломалось. Это последняя часть пазла — превращение вас из junior в middle разработчика.


# Материалы
---
## Ключевые метрики
---
### 1. Отставание потребителя (Consumer Lag) - Критично!

**Отставание потребителя** = Последнее смещение в разделе - Текущее смещение потребителя

```bash
# Посмотреть отставание для группы
kafka-consumer-groups --bootstrap-server localhost:9092 \
  --group обработчики-заказов \
  --describe

# Результат:
# ГРУППА            ТЕМА      РАЗДЕЛ ТЕКУЩЕЕ-СМЕЩЕНИЕ ПОСЛЕДНЕЕ-СМЕЩЕНИЕ ОТСТАВАНИЕ     
# обработчики-заказов заказы 0     850             1000            150     
# обработчики-заказов заказы 1     500             600             100     
```

**Интерпретация**:
- ОТСТАВАНИЕ = 0: Потребитель в согласовании с производителем (процессы идут в ногу)
- ОТСТАВАНИЕ растет: Потребитель отстает (производитель пишет быстрее чем потребитель обрабатывает)
- ОТСТАВАНИЕ падает: Потребитель наверстывает (обработка быстрее чем новые данные)

**Оповещения**:
- Если ОТСТАВАНИЕ > некий порог (например, > 1000000) → Оповещение!
- Если ОТСТАВАНИЕ растет в течение часа → Оповещение!

### 2. Пропускная способность производителя

```bash
# Количество сообщений в секунду
сообщений_в_сек = сообщений_произведено / затраченное_время

# Метрики в Kafka:
# kafka.producer.record.send.total
# kafka.producer.records.per.request.avg
```

**Что мониторить**:
- Ожидаемая пропускная способность (должна быть относительно стабильна)
- Скачки (внезапные скачки = проблемы)
- Ниже ожидаемого = производитель медленнее чем обычно

### 3. Использование диска брокера

```bash
# На каждом брокере
df -h /var/kafka-logs/

# Или через JMX:
# kafka.server.log.LogFlushStats
```

**Почему это важно**:
- Если диск полный (100%), Kafka остановится
- Нужна экстраполяция: "При текущей скорости, диск заполнится через 5 дней"

**Решение**: Удалить старые сообщения (retention), или добавить диск.

### 4. CPU и память брокера

```bash
# На каждом брокере
top / htop

# Или через систему мониторинга (Prometheus)
# process.cpu.percent
# process.resident.memory.bytes
```

**Интерпретация**:
- CPU > 80% → Нужна оптимизация или больше брокеров
- Память > 80% → Нужно увеличить heap или добавить брокер

### 5. Размер ISR (синхронизированных копий)

```bash
# В каждый момент времени, сколько копий синхронизировано?
jconsole
# Посмотреть: kafka.server:type=ReplicaManager,name=PartitionsWithoutHealthyLeader
```

**Интерпретация**:
- ISR меньше коэффициента репликации → На что-то что-то не так
- Нет ISR → Катастрофа!

## Инструменты мониторинга
---

### Kafka Manager / CMAK

Веб-интерфейс для управления Kafka кластером.

```bash
docker run -d -p 9000:9000 \
  -e ZK_HOSTS="localhost:2181" \
  hlebalbau/kafka-manager:latest
```

**Что можно делать**:
- Видеть все темы, разделы, брокеры
- Смотреть группы потребителей и их отставание
- Добавлять/удалять темы
- Переассигнать разделы

### Prometheus + JMX Exporter

Собирать метрики из Kafka через JMX.

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'kafka'
    static_configs:
      - targets: ['localhost:5555']  # JMX exporter port
```

**Метрики**:
- `kafka_topic_partitions` - число разделов per тема
- `kafka_server_replicamanager_leadercount` - сколько лидеров на этом брокере
- `kafka_consumer_lag` - отставание потребителя

### Grafana (Визуализация)

Построить панель в Grafana с источником данных Prometheus.

```
Панель показывает:
- Отставание потребителя за время
- Пропускная способность производителя
- Метрики брокера
- Оповещения для критичных метрик
```

## Типичные проблемы и решение
---

### Проблема 1: Отставание потребителя растет

**Симптомы**:
- `kafka-consumer-groups --describe` показывает ОТСТАВАНИЕ > 100000 и растет
- Процессы потребителей выглядят как working

**Диагностика**:
```bash
# Проверить: Процессы потребителя live?
ps aux | grep kafka-consumer

# Проверить: Какой процесс читает?
jps -l

# Смотреть логи потребителя
tail -f /var/log/обработчик-заказов.log
```

**Возможные причины**:
1. **Потребитель слишком медленный**: Обработка одного сообщения занимает много времени
   - Решение: Оптимизировать обработкуСообщения(), или добавить больше потребителей

2. **Производитель очень быстрый**: Слишком много данных за раз
   - Решение: Если OK то ничего, потребитель просто наверстает

3. **Потребитель упал/перезагружается**: Видны в логах
   - Решение: Проверить что случилось, и перезапустить gracefully

4. **Проблемы сети**: Connection taimeouts
   - Решение: Проверить сетевые кабели, правила firewall

### Проблема 2: ISR уменьшилась

**Симптомы**:
```bash
# Было 3, стало 1:
# kafka.server:type=ReplicaManager,name=UnderReplicatedPartitions: 100
```

**Диагностика**:
```bash
# Какие брокеры offline?
kafka-broker-api-versions.sh --bootstrap-server localhost:9092

# Что не синхронизируется?
kafka-topics.sh --bootstrap-server localhost:9092 \
  --describe --under-replicated-partitions
```

**Возможные причины**:
1. **Брокер упал**: Нужно запустить
2. **Брокер слишком медленный**: Не может реплицировать вовремя
3. **Разделение сети**: Брокеры не могут общаться

**Решение**: 
- Если брокер мертв: Запустить его, потом проверить логи
- Если медленный: Проверить disk I/O, CPU, Memory
- Если сетевое разделение: Проверить firewall, кабели

### Проблема 3: Производитель получает ошибки

**Ошибка**: `BROKER_NOT_AVAILABLE`

```go
ошибка := писатель.WriteMessages(ctx, сообщение)
if ошибка != nil {
    log.Printf("Ошибка: %v", ошибка)
    // output: Ошибка: брокер недоступен
}
```

**Диагностика**:
```bash
# Все ли брокеры live?
kafka-broker-api-versions.sh --bootstrap-server localhost:9092 --list

# Что говорит брокер?
telnet localhost:9092  # Должно работать
```

**Решение**:
- Проверить что все брокеры запущены
- Проверить что адреса правильные в конфигурации производителя
- Проверить firewall между производителем и kafka

### Проблема 4: Потребитель получает `GROUP_COORDINATOR_NOT_AVAILABLE`

**Симптомы**:
```
Ошибка: координатор группы недоступен
```

**Причина**: Координатор группы потребителей неизвестен или недоступен.

**Решение**:
- Убедитесь что `__consumer_offsets` тема создана
- Убедитесь что брокер-координатор live
- Перезапустите потребителя

## Корректное выключение (Graceful Shutdown)
---

**Производитель**:
```go
// Перед выключением
defer писатель.Close() // Флашит pending сообщения

// Или более явно:
ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
defer cancel()
писатель.Close()
```

**Потребитель**:
```go
// Перехватить сигнал
sigChan := make(chan os.Signal, 1)
signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)

go func() {
    <-sigChan
    читатель.Close() // Gracefully close, фиксируем смещения
    os.Exit(0)
}()
```

## Типичные вопросы собеседования
---

**В: Отставание потребителя 1000000. Это плохо?**
О: Зависит. Если потребитель только запустился и начинает с древней истории — нормально. Если это случается во время production и растет — RED FLAG.

**В: Как я знаю если потерял сообщения?**
О: Мониторьте количество on производителе против потребителя. Если количество потребителя < количество производителя, потеря произошла. Или смотреть ISR — если упала до 1 и был сбой, потеря возможна.

**В: Почему мой потребитель вдруг начал читать с начала темы?**
О: Вероятнее всего, смещение было повреждено или удалено. Auto.offset.reset=earliest сработал. Решение: проверить `__consumer_offsets` тему, и может быть сбросить смещения группы.

**В: Как я масштабирую пропускную способность?**
О: Добавьте больше потребителей в группу (до количества разделов). Или добавьте больше брокеров и переассигнайте разделы.

---

**[← Назад к Kafka](../)**