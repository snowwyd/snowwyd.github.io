---
layout: default
title: Репликация и отказоустойчивость
permalink: /interview-prep/databases-cache/kafka/replication/
---

# Цель
---
Репликация — это то, что делает Kafka надежной и готовой к production. Если брокер падает, данные не теряются. Это ключевая фишка.

# Материалы
---
## Как работает репликация
---

Каждый раздел может быть реплицирован на несколько брокеров.

**Пример**:
```
Тема: заказы
Раздел 0:
├─ Лидер на Брокере 1
├─ Копия на Брокере 2
└─ Копия на Брокере 3
```

**Как это работает**:
1. Производитель отправляет сообщение на **Лидера** (Брокер 1)
2. Лидер добавляет сообщение в свой журнал
3. Лидер отправляет копию на Копии (Брокер 2 и 3)
4. Копии подтверждают, что получили
5. Лидер отправляет подтверждение производителю

## Коэффициент репликации
---

**Коэффициент репликации** = на скольких брокерах хранится каждый раздел.

```
коэффициент_репликации = 1: Только на одном брокере (нет резервирования)
коэффициент_репликации = 2: На двух брокерах (если упадет 1 — OK)
коэффициент_репликации = 3: На трех брокерах (если упадут 2 — OK)
```

**Выбор**:
- **Разработка/Тестирование**: 1 (экономия ресурсов)
- **Production**: 3 (если упадут 2 брокера из 5, еще OK)
- **Очень критично**: 5 (режим параноика)

**Компромисс**: Выше коэффициент → больше надежность, но больше дискового пространства и сетевого трафика (данные реплицируются).

**Пример расчета**:
```
Размер темы: 100GB
коэффициент_репликации: 3
Необходимо дискового пространства: 100GB * 3 = 300GB
```

## Синхронизированные копии (ISR)
---

**ISR** — это множество копий, которые синхронизированы с лидером.

```
Тема: заказы
Раздел 0:
├─ Лидер на Брокере 1 → всегда в ISR
├─ Копия на Брокере 2 → в ISR если синхронизирована
└─ Копия на Брокере 3 → может быть не в синхронизации
```

**Что значит "синхронизирована"?**

Копия считается синхронизированной если:
- Сердцебиение было в последние `replica.lag.time.max.ms` (по умолчанию: 10 сек)
- Отставание между лидером и копией меньше чем `replica.lag.max.messages`

**Почему это важно?**

Производитель может быть сконфигурирован:
```
acks=all: Жди пока ВСЕ ISR подтвердят
```

Если копии offline, ISR уменьшается. Если ISR < min.insync.replicas (по умолчанию: 1), производитель получает ошибку!

```go
// Если ISR=1 и мы требуем min.insync.replicas=2:
писатель := &kafka.Writer{
    Acks: -1, // ждем всех ISR
    // Если ISR < 2, получим ошибку
}
```

## Выборы лидера (Leader Election)
---

Когда лидер брокер падает, нужно выбрать нового лидера из ISR.

**Процесс**:
1. ZooKeeper (или KRaft) замечает, что лидер мертв
2. Выбирает нового лидера из ISR
3. Новый лидер становится... лидером
4. Старый лидер, если вернется, становится копией

**Какой выбрать нового лидера?**

Обычно выбирается первый в списке ISR (лексикографический порядок). Это гарантирует детерминизм.

**Время**:
- Зависит от `replica.lag.time.max.ms` (время обнаружения)
- Плюс время координации ZooKeeper
- Итого: обычно 10-30 секунд в production

## Опасная ситуация - Нечистые выборы (Unclean Leader Election)
---

Что если **ВСЕ** синхронизированные копии упали?

```
Лидер: Брокер 1 (ОК) - Смещение 100
Копия 1: Брокер 2 (УПАЛА) - Смещение 98
Копия 2: Брокер 3 (УПАЛА) - Смещение 95
ISR = [Брокер 1]

Брокер 1 ПАДАЕТ!
```

Теперь нет никого в ISR. Есть два варианта:

### Опция 1: `unclean.leader.election.enable = false` (безопасный режим)
- Ждем пока лидер вернется
- Если лидер не вернется, нужно ручное вмешательство
- ✅ Нет потери данных
- ❌ Система выключена

### Опция 2: `unclean.leader.election.enable = true` (режим восстановления)
- Выбираем любую живую копию в качестве лидера (даже если она отстала)
- Система продолжает работать
- ✅ Высокая доступность
- ❌ Может быть потеря последних сообщений

**В production**: Обычно `false` (нет потерь > доступность).

## Отказоустойчивость при масштабировании
---

**Сценарий**: У вас 5 брокеров, 10 разделов, коэффициент_репликации=3.

```
Брокер 1: разделы 0,1 лидер; 3,4 копия
Брокер 2: разделы 1,2 лидер; 5,6 копия
Брокер 3: разделы 3,4 лидер; 7,8 копия
Брокер 4: разделы 5,6 лидер; 9,0 копия
Брокер 5: разделы 7,8,9 лидер
```

Падает Брокер 1:
- Его лидеры (0,1) переходят на других
- Его копии теряются, но лидеры все еще работают
- Kafka перенесет копии на другие брокеры (переназначение)

**Ключ**: Хороший design кластера гарантирует что падение одного брокера не критично.

## Типичные вопросы собеседования
---

**В: Какой коэффициент репликации выбрать?**
О: Зависит. Для production обычно 3. Если очень критично — 5. Для разработки — 1 для экономии ресурсов.

**В: Может ли потеря лидера привести к потере данных?**
О: С acks=all и достаточным ISR — нет, данные реплицированы. С acks=1 — может быть, если лидер упадет до репликации.

**В: Я вижу ISR=[1,3,5] но копий должно быть 3. Все ли OK?**
О: ISR = синхронизированные копии. Если 3 в ISR значит 3 синхронизированы. Если меньше - значит некоторые отстали. Не критично если min.insync.replicas <= размер ISR.

**В: Как я могу пересбалансировать разделы между брокерами?**
О: Используйте `kafka-reassign-partitions`. Это медленная операция, не делайте часто.

---

**[← Назад к Kafka](../)**